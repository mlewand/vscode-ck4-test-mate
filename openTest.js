
( function() {
	'use strict';

	let vscode = require( 'vscode' );

	exports = function( context ) {
		let curEditor = vscode.window.activeTextEditor,
			curDocument = curEditor && curEditor.document,
			filePath;

		if ( !curDocument ) {
			return false;
		}

		if ( curDocument.uri.scheme !== 'file' ) {
			vscode.window.showInformationMessage( `Sorry, this file uses "${curDocument.uri.scheme}" protocol while only "file" is supported.` );
			return false;
		}

		// Keeps path like /c:/foo-bar/ck4-test-mate/foo.js.
		filePath = curDocument.uri.path;

		let testUrl = exports.pathToUrl( filePath );

		if ( testUrl ) {
			const opn = require( 'opn' );
			opn( module.exports.pathToUrl( testUrl ) );
		} else {
			vscode.window.showInformationMessage( `Sorry, we've been unable to pick up test URL for this file. :(` );
		}
	};

	/**
	 * Converts file path into a relevant test URL.
	 *
	 * @param {String} filePath File path in Unix format. Must not use Windows separators!
	 * @returns {String/Boolean}
	 */
	exports.pathToUrl = function( filePath ) {
		let parts = filePath.split( '/' ),
			testsPartIndex = parts.indexOf( 'tests' ),
			fileName = parts[ parts.length - 1 ],
			testsAddress = exports.testsAddress;

		if ( testsPartIndex === -1 ) {
			// Clearly not in a test directory.
			return false;
		}

		// Note, it includes "tests" part.
		parts = parts.slice( testsPartIndex );

		// Remove extension form the last part (if present).
		if ( fileName.indexOf( '.' ) !== -1 ) {
			parts[ parts.length - 1 ] = fileName.substr( 0, fileName.lastIndexOf( '.' ) );
		}

		return `${testsAddress.protocol}://${testsAddress.domain}:${testsAddress.port}/${parts.join( '/' )}`;
	};

	exports.testsAddress = {
		protocol: 'http',
		domain: 'tests.ckeditor.test',
		port: 1030
	};

	module.exports = exports;
} )();